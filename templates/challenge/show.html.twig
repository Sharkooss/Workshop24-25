{% extends 'base.html.twig' %}

{% block title %}Défi{% endblock %}

{% block body %}
<div class="container">
    <h1>{{ challenge.nameChallenge }}</h1>
    <p>{{ challenge.descritpionChallenge }}</p>

    <h3>Participants</h3>
    <ul class="list-group" id="participants-list">
        <li class="list-group-item d-flex justify-content-between align-items-center">
            {{ challenge.challengeds[0].challenger.getName() }} vs {{ challenge.challengeds[0].opponent.getName() }}
            <span class="badge bg-info status-badge">
                {% if challenge.challengeds[0].status == 'accepted' %}
                    Accepté
                {% else %}
                    En attente
                {% endif %}
            </span>
        </li>
    </ul>

    {% if challenge.challengeds[0].status == 'accepted' %}
        <button class="btn btn-primary mt-4" data-bs-toggle="modal" data-bs-target="#selectWinnerModal">Choisir le vainqueur</button>
    {% endif %}

    {% if selectionComplete %}
        <p class="alert alert-success mt-3">Le gagnant a été désigné par les deux participants.</p>
    {% endif %}
</div>

<!-- Modal for selecting winner -->
<!-- Modale pour choisir le vainqueur -->
<div class="modal fade" id="selectWinnerModal" tabindex="-1" aria-labelledby="selectWinnerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="selectWinnerModalLabel">Choisir le Vainqueur</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <p>Sélectionnez le vainqueur :</p>
                    <div class="d-flex justify-content-center align-items-center">
                        <label class="form-switch">
                            <input type="radio" name="winner" value="{{ challenge.challengeds[0].challenger.id }}" id="challenger" style="display:none;" />
                            <span class="custom-switch"></span>
                            {{ challenge.challengeds[0].challenger.getName() }}
                        </label>
                        <label class="form-switch mx-4">
                            <input type="radio" name="winner" value="{{ challenge.challengeds[0].opponent.id }}" id="opponent" style="display:none;" />
                            <span class="custom-switch"></span>
                            {{ challenge.challengeds[0].opponent.getName() }}
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <button type="button" class="btn btn-primary" id="validateWinnerBtn">Valider</button>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('validateWinnerBtn').addEventListener('click', function() {
    const selectedWinner = document.querySelector('input[name="winner"]:checked').value;

    if (selectedWinner) {
        // Effectuer un appel AJAX pour soumettre la sélection du gagnant
        fetch(`/challenge/select_winner/{{ challenge.challengeds[0].id }}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': '{{ csrf_token('challenge') }}'
            },
            body: JSON.stringify({ winner: selectedWinner })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Le gagnant a été sélectionné.');
                window.location.reload();
            } else if (data.reset) {
                alert('Les deux joueurs n\'ont pas sélectionné le même gagnant. Veuillez réessayer.');
                window.location.reload();
            }
        })
        .catch(error => console.error('Erreur:', error));
    } else {
        alert('Vous devez sélectionner un vainqueur.');
    }
});
</script>

<style>
    .form-switch {
        display: flex;
        align-items: center;
        cursor: pointer;
        padding: 5px;
    }

    .custom-switch {
        width: 40px;
        height: 20px;
        background-color: #ddd;
        border-radius: 20px;
        position: relative;
        margin-right: 10px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .custom-switch::before {
        content: '';
        position: absolute;
        width: 18px;
        height: 18px;
        background-color: white;
        border-radius: 50%;
        top: 1px;
        left: 1px;
        transition: transform 0.3s;
    }

    input[type="radio"]:checked + .custom-switch::before {
        transform: translateX(20px);
    }

    input[type="radio"]:checked + .custom-switch {
        background-color: #007bff;
    }
</style>
{% endblock %}
